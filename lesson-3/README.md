-- 1. Создать таблицу с текстовым полем и заполнить случайными или сгенерированными
-- данным в размере 1 млн строк
-- 2.  Посмотреть размер файла с таблицей
-- 3. 5 раз обновить все строчки и добавить к каждой строчке любой символ
-- 4. Посмотреть количество мертвых строчек в таблице и когда последний раз приходил автовакуум
-- 5. Подождать некоторое время, проверяя, пришел ли автовакуум
-- 6. 5 раз обновить все строчки и добавить к каждой строчке любой символ
-- 7. Посмотреть размер файла с таблицей
-- 8. Отключить Автовакуум на конкретной таблице
-- 9. 10 раз обновить все строчки и добавить к каждой строчке любой символ
-- 10. Посмотреть размер файла с таблицей
-- 11. Объясните полученный результат
-- 12. Не забудьте включить автовакуум


# PostgreSQL Автовакуум и Управление Размером Таблицы

## 1. Создать таблицу с текстовым полем и заполнить случайными данными в размере 1 млн строк

```sql
CREATE TABLE IF NOT EXISTS test_lesson_3 (
    name TEXT
);

-- Заполняем 1 млн случайно сгенерированных строк
INSERT INTO test_lesson_3 (name)
SELECT md5(random()::text)
FROM generate_series(1, 1000000);
```

## 2. Посмотреть размер файла с таблицей

```sql
-- Получаем размер файла с таблицей
SELECT pg_size_pretty(pg_total_relation_size('test_lesson_3')) AS total_size;
-- Результат: 65 MB
```

## 3. 5 раз обновить все строки таблицы и добавить к каждой строке любой символ

```sql
DO
$$
    DECLARE
        i INTEGER;
    BEGIN
        FOR i IN 1..5 LOOP
            UPDATE test_lesson_3
            SET name = name || 'X'; -- Добавляем символ 'X' в конец каждой строки
        END LOOP;
    END
$$;
```

## 4. Посмотреть количество мертвых строк в таблице и когда последний раз приходил автовакуум

```sql
-- Количество мертвых строк (dead tuples)
SELECT relname AS table_name,
       n_dead_tup AS dead_tuples
FROM pg_stat_all_tables
WHERE relname = 'test_lesson_3';
-- Ожидаемый результат: 5 млн мертвых строк

-- Смотрим, когда последний раз приходил автовакуум
SELECT relname AS table_name,
       last_autovacuum
FROM pg_stat_all_tables
WHERE relname = 'test_lesson_3';
-- Результат: test_lesson_3, 2024-10-20 19:24:47
```

## 5. Подождать некоторое время, проверяя, пришел ли автовакуум

```sql
-- Проверяем, что автовакуум пришел
-- После автовакуума мертвых строк больше нет
SELECT n_dead_tup, last_autovacuum
FROM pg_stat_all_tables
WHERE relname = 'test_lesson_3';
-- Результат: мертвых строк 0, последний автовакуум 2024-10-20 20:45:08
```

## 6. 5 раз обновить все строки и добавить к каждой строке любой символ

```sql
DO
$$
    DECLARE
        i INTEGER;
    BEGIN
        FOR i IN 1..5 LOOP
            UPDATE test_lesson_3
            SET name = name || 'X'; -- Добавляем символ 'X' в конец каждой строки
        END LOOP;
    END
$$;
```

## 7. Посмотреть размер файла с таблицей

```sql
SELECT pg_size_pretty(pg_total_relation_size('test_lesson_3')) AS total_size;
-- Результат: 415 MB
```

## 8. Отключить автовакуум на конкретной таблице

```sql
ALTER TABLE test_lesson_3 SET (autovacuum_enabled = false);

-- Проверяем, что автовакуум отключен
SELECT relname, reloptions
FROM pg_class
WHERE relname = 'test_lesson_3';
-- Результат: {autovacuum_enabled=false}
```

## 9. 10 раз обновить все строки и добавить к каждой строке любой символ

```sql
DO
$$
    DECLARE
        i INTEGER;
    BEGIN
        FOR i IN 1..10 LOOP
            UPDATE test_lesson_3
            SET name = name || 'X'; -- Добавляем символ 'X' в конец каждой строки
        END LOOP;
    END
$$;
```

## 10. Посмотреть размер файла с таблицей

```sql
SELECT pg_size_pretty(pg_total_relation_size('test_lesson_3')) AS total_size;
-- Результат: 841 MB
```

## 11. Объяснение результата

Размер файла таблицы увеличивается, так как при каждом обновлении PostgreSQL создает новые версии строк, оставляя старые версии (мертвые строки) до их очистки. После отключения автовакуума мертвые строки не удаляются, что приводит к значительному увеличению размера таблицы.

Даже если мертвые строки будут удалены позже, физический размер файла на диске не уменьшится, так как PostgreSQL не возвращает пространство автоматически. Это пространство может быть использовано только для новых данных.

## 12. Включить автовакуум обратно

```sql
ALTER TABLE test_lesson_3 SET (autovacuum_enabled = true);
```

После включения автовакуума, таблица все еще занимает 841 MB, но мертвые строки будут автоматически очищаться в будущем.

Чтобы физически освободить место на диске, можно выполнить:

```sql
VACUUM FULL;
-- Результат: 81 MB, почти как было изначально!
```
